<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Results</title>

    <base href="../"/>
    <link href="images/icon.ico" rel="icon">
    <link href="assets/css/ubiquitous.css" rel="stylesheet">

    <!-- INSERT PARTIAL: ubiquitous/google_analytics_tag.html -->

    <!-- INSERT PARTIAL: ubiquitous/bootstrap_links.html -->

    <link href="https://cdn.datatables.net/1.11.1/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.0.0/css/buttons.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/scroller/2.0.5/css/scroller.dataTables.min.css" rel="stylesheet">
    

    <script src="https://cdn.datatables.net/1.11.1/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.0/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/scroller/2.0.5/js/dataTables.scroller.min.js"></script>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.9.0.min.js"></script>

    <style>
        .selector-nav-link {
            font-size: 1.1em;
        }
    </style>

</head>
<body>

    <div id="wrapper" class="d-flex flex-column min-vh-100">

        <!-- INSERT PARTIAL: ubiquitous/header.html -->

        <div class="card mx-4 my-2">

            <div class="card-header">
                <div class="d-flex justify-content-between">
                    <h5 class="card-title display-4">Results</h5>
                    <div class="text-center px-5" style="width:25%;">
                        <a id="downloadButton" class="btn btn-outline-dark py-3 px-1" style="width:100%; cursor: pointer; font-size: 1.6em;"
                        href="/* INSERT VALUE: linkToZip */" download="TurboPutativeResults.zip">
                            Download results
                        </a>
                    </div>
                </div>  
            </div>

            <div class="card-body">

                <ul class="selector-nav-link nav nav-tabs" role="tablist">
                    <!-- INSERT VALUE: NavTab -->
                </ul>

                <div id="loading-element" class="text-center">
                    <div class="spinner-border text-danger m-5" id="loading-element" style="width:100px; height:100px;"></div>
                </div>
                <div id="table-content" class="mt-1">
                    <!-- INSERT VALUE: TabContent -->
                </div>
            </div>

        </div>

        <!-- INSERT PARTIAL: ubiquitous/footer.html -->

    </div>

</body>

<script>

    function plotRowNumber(metadata, jsonRows){

        let rowNumbers = [];

        metadata.types.forEach(element => {
            rowNumbers.push(
                jsonRows[
                    metadata.type2tablename[element]
                ].length
            );
        });

        $('#div-TP-summary').append(`
            <div class="pt-4">
                <div class="display-4 text-center mb-2" style="font-family:'Open Sans', verdana, arial, sans-serif; font-size:2em;">Table Complexity</div>
                <div id="rowNumberPlot" class="container"></div>
            </div>
        `)

        let data = [
            {
                x:metadata.types.map(elem => metadata.type2basename[elem]),
                y:rowNumbers,
                type:'scatter'
            }
        ]

        let layout = {
            /*title:{
                text: 'Table Complexity',
                font: {
                    size: 24
                }
                
            },*/
            margin:{t:0},
            yaxis: {
                title: {
                    text: 'Row Number',
                    font: {
                       size: 16
                    }
                }
            }
        }

        Plotly.newPlot('rowNumberPlot', data, layout, {staticPlot:true});

        return rowNumbers;
    }

</script>

<script>

    function plotTagger(taggerRows){

        let shape = [taggerRows.length, taggerRows[0].length];

        // Identify tags present in the table
        let tags = [];
        let tag_idx = []
        
        for (let i=0; i<shape[1]; i++){
            let colName = $(`#${resJSON.metadata.type2tablename['Tagger']}`).children('thead').children('tr').children()[i].textContent;
            if (['Peptide', 'Plant', 'NaturalProduct', 'MDM', 'Drug', 'Food'].includes(colName)){
                tags.push(colName);
                tag_idx.push(i);
            }
        }

        // Count each tag type
        let tag_n = tags.map(e => 0);
        let tag_any = 0

        taggerRows.forEach(row => {
            let tagCells = row.filter((e, i) => tag_idx.includes(i));
            let tag_bool = tagCells.map(e => e!='-');
            tag_bool.some(e => e) && tag_any++;
            tag_bool.forEach((e, i) => {
                e && tag_n[i]++;
            });
        });

        // Plot Pie chart
        $('#div-TP-summary').append(`
            <div class="mt-2">
                <div class="display-4 text-center mb-2" style="font-family:'Open Sans', verdana, arial, sans-serif; font-size:2em;">Classified Compounds</div>
                <div id="TaggerPlot" class="container d-flex justify-content-around">
                    <div id="TaggerPlot1" class="d-flex justify-content-center container"></div>
                    <div id="TaggerPlot2" class="d-flex justify-content-center container"></div>
                </div>
            </div>
        `)

        let data = [
            {
                values: [tag_any, shape[0]-tag_any],
                labels: ['Tagged', 'Untagged'],
                type: 'pie',
                textinfo: "label+percent+value",
                textpostiion: "outside",
         
                opacity: 0.8
            
            }
        ]

        let layout = {
            /*title: {
                text: "Classified compounds",
                font: {
                    size: 24
                }
            },*/
            height: 400,
            width: 400,
            //margin: {'t':0, 'b':0, 'l':0, 'r':0},
            showlegend: false,
            hovermode: false,
        }

        Plotly.newPlot('TaggerPlot1', data, layout, {staticPlot:true});
        
        // Plot separated tags
        /*
        data = tags.map( (e,i) => {
            return {
                values: [tag_n[i], shape[0]-tag_n[i]],
                labels: [e, 'Untagged'],
                type:'pie',
                textinfo: "label+percent+value",
                textpostiion: "outside",
                domain:{row: Math.floor(i/3), column:i%3}
            }
        } );

        layout = {
            height:400,
            width: 400,
            grid:  {rows: Math.floor(tags.length/3), columns: 3},
            showlegend: false,
            hovermode: false,
        };*/

        data = [{
            y: tag_n,
            x: tags,
            type: 'bar',
            marker: {
                opacity: 0.6
            }
        }]

        layout = {
            height:400,
            width: 600,
            
            showlegend: false,
            hovermode: false,
        };


        Plotly.newPlot('TaggerPlot2', data, layout, {staticPlot:true});
        
        
     
        return [tag_any, tag_n]
    }

</script>


<script>

    var resJSON = {};
    $(document).ready( function () {


        var jobID = "/* INSERT VALUE: jobID */";

        const req = new XMLHttpRequest();
        req.responseType = "json";
        req.open('GET', `viewresults/get/${jobID}`);
        req.onload = () => {
            
            resJSON = req.response;

            // Plots
            plotRowNumber(resJSON.metadata, resJSON.jsonRows)
            resJSON.metadata.types.includes("Tagger") && plotTagger(resJSON.jsonRows[resJSON.metadata.type2tablename["Tagger"]]);

            // Tables
            for (key in resJSON.jsonRows)
            {
                $(`#${key}`).DataTable( {
                    data:           resJSON.jsonRows[key],
                    deferRender:    true,
                    scrollY:        500,
                    scrollX:        true,
                    scrollCollapse: true,
                    scroller:       true,
                    } );
            }


            $('#loading-element').hide();
            $('.table-selector')[0].click();
        }
        req.send();
    } );

    $('.table-selector').click( function() {
        $('.table-selector').removeClass('active');
        this.classList.add('active');
        $('.table-container').hide();

        let target = $(this).attr('target');
        let div_id = `div-${target}`
        $(`#${div_id}`).show();
        target != "TP-summary" && $(`#${target}`).DataTable().columns.adjust().draw();
    })

    
</script>
<!-- INSERT PARTIAL: ubiquitous/cookie_alert.html -->
</html>